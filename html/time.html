<!doctype html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>北京轨道交通路网列车衔接模型</title>
		<link rel="stylesheet" href="resources/blueprint/screen.css" type="text/css">
		<!--[if lt IE 8]><link rel="stylesheet" href="resources/blueprint/ie.css" type="text/css"><![endif]-->
		<style type="text/css">
.menu { padding:15px 10px; margin:5px 0; background-color:#36F; }
.menu a { color:#FFF; font-weight:bold; }
.radius-border { -moz-border-radius:4px; -webkit-border-radius:4px; border:1px solid #aaa; }
.query-box-title { -moz-border-radius-topleft: 4px; -webkit-border-top-left-radius: 4px; -moz-border-radius-topright: 4px; -webkit-border-top-right-radius: 4px;
	background:-moz-linear-gradient(top, #FFF, #B3DCFD); background:-webkit-linear-gradient(top, #FFF, #B3DCFD); padding:10px 20px; font-weight:bold; }
.query-box-body { height:280px; padding:10px; position:relative; }
#stations { width:160px; margin-left:40px; }
#lines-from,#lines-to { width:100px; margin-left:10px; }
.query-box-body .buttons { position:absolute; bottom:0px; padding-left:100px; }
.query-box-body button { -moz-border-radius:6px; -webkit-border-radius:6px; border:1px solid #68ACF0; background-color:#D4EAFF;
	padding:8px 16px; margin:0 10px; font-size:16px; font-weight:bold; cursor:pointer; }
.overview { overflow:hidden; position:relative; border:1px solid #aaa; }
.overview button { -moz-border-radius:10px; -webkit-border-radius:10px; border:1px solid #6699CC; background-color:#6699CC;
	position:absolute; width:30px; height:30px; font-size:18px; font-weight:bold; color:#FFF; cursor:pointer; }
.overview img { position:absolute; top:0; left:0; }
.station-view { position:relative; }
.station-view h2 { position:absolute; top:165px; left:195px; color:#FFF; }
.station-view h3 { position:absolute; color:#FFF; }
.station-view table { position:absolute; top:400px; right:0px; width:680px; border-top:1px solid #888; border-left:1px solid #888; }
.station-view th, .station-view td { border-bottom:1px solid #888; border-right:1px solid #888; }
.station-view .tooltip { position:absolute; width:160px; height:120px; padding:5px; background-color:#a4a4a4;
	-moz-border-radius:8px; -webkit-border-radius:8px; border:3px solid #6fc; }
#map-tooltip { position:absolute; width:160px; height:130px; padding:5px; background-color:#fff;
	-moz-border-radius:8px; -webkit-border-radius:8px; border:3px solid #39f; }
.close-btn-icon { background-image:url(resources/images/icons.png); background-position:-96px -128px;
	width:16px; height:16px; right:5px; position:absolute; cursor:pointer; }
#lines-from-mini,#lines-to-mini { width:70px; }
.confirm-btn-icon { background-image:url(resources/images/icons.png); background-position:-64px -144px;
	width:16px; height:16px; position:absolute; bottom:10px; right:10px; cursor:pointer; }
select.hours,select.minutes { width:50px; margin-left:10px; }
		</style>
		<script type="text/javascript" src="resources/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="resources/raphael.js"></script>
		<script type="text/javascript">
$(function() {
	// ---------- 查询输入框相关 ----------------
	// 获取所有换乘站点名称
	$.post("../Service?method=getAllTransferStations", function(result) {
		if(!result) return;
		var stations = $("#stations");
		$.each(result, function() {
			if(this.id == 224) return;
			$("<option/>").val(this.id).text(this.name).appendTo(stations);
		});
	}, "json");
	var _linesDirInStation = {};
	// 获取换乘点，线路方向（东西向/南北向）
	$.post("service/getAllLinesDirectionInStation.json", function(result) {
		if(!result) return;
		_linesDirInStation = result;
	}, "json");
	var _linesColor = {};
	// 获取线路代表色
	$.post("service/getAllLinesColor.json", function(result) {
		if(!result) return;
		_linesColor = result;
	}, "json");
	// 选择一个车站
	var _availableRoutes = {};
	window.chooseStation = function(stationId, fromLinesSelector, toLinesSelector, callback) {
		$.post("../Service?method=findRoutesByStation", { stationId: stationId }, function(result) {
			if(!result) return;
			var fromLines = {}, toLines = {};
			_availableRoutes = {};
			$.each(result, function() {
				fromLines[this.fromLine.lineId] = this.fromLine.lineName;
				toLines[this.toLine.lineId] = this.toLine.lineName;
				_availableRoutes[this.routeId] = { fromLine: this.fromLine, toLine: this.toLine };
			});
			var from = $(fromLinesSelector).empty();
			for(var id in fromLines)
				$("<option/>").val(id).text(fromLines[id]).appendTo(from);
			var to = $(toLinesSelector).empty();
			for(var id in toLines)
				$("<option/>").val(id).text(toLines[id]).appendTo(to);
			if(from.val() == to.val())
				to.children(":first").next().attr("selected", true);
			callback();
		}, "json");
	};
	$("#stations").change(function() {
		if($(this).val() == 0) {
			_availableRoutes = {};
			$("#lines-from,#lines-to").closest("p").fadeOut();
			return;
		}
		chooseStation($(this).val(), "#lines-from", "#lines-to", function() {
			$("#lines-from,#lines-to").closest("p").fadeIn().find(":checkbox").attr("checked", true);
		});
	});
	// 选择线路
	$("#lines-from,#lines-to").change(function() {
		var me = $(this);
		var she = me.closest("p").siblings(".lines").children("select");
		if(me.val() == she.val())
			she.children(":selected").siblings(":first").attr("selected", true);
	});
	// 选择方向
	$("#lines-from ~ :checkbox,#lines-to ~ :checkbox").change(function() {
		if($(this).attr("checked")) return;
		$(this).siblings(":checkbox:first").attr("checked", true);
	});
	// 选择时间点
	var hours = $("select.hours");
	for(var i = 0; i < 24; i++)
		$("<option/>").val(i).text(i).appendTo(hours);
	var minutes = $("select.minutes");
	for(var i = 0; i < 60; i++)
		$("<option/>").val(i).text(i).appendTo(minutes);
	hours.val(new Date().getHours());
	minutes.val(new Date().getMinutes());
	// 检索动作
	var stopLastAnimation = null;
	window.queryAction = function(stationId, stationName, fromLineSelector, toLineSelector, fromLineDirsSelector, toLineDirsSelector) {
		var from = $(fromLineSelector).val(), to = $(toLineSelector).val();
		var fromDirs = $(fromLineDirsSelector), toDirs = $(toLineDirsSelector);
		var routes = [];
		$.each(_availableRoutes, function(routeId) {
			if(this.fromLine.lineId == from && this.toLine.lineId == to
					&& fromDirs.filter(":checked[value="+this.fromLine.lineDir+"]").length > 0
					&& toDirs.filter(":checked[value="+this.toLine.lineDir+"]").length > 0)
				routes.push(routeId);
		});
		if(routes.length == 0) {
			alert("没有符合条件的换乘路线");
			return;
		}
		var time = new Date();
		time.setHours(hours.val());
		time.setMinutes(minutes.val());
		$.post("../Service?method=findTransferSolutionByTime", {stationId: stationId, routeIds: routes.join(","), time:time.getTime()}, function(result) {
			if(!result) return;
			var routes = [];
			$.each(result.lastest, function() {
				var route = _availableRoutes[this.routeId];
				var tr = "<tr>";
				tr += "<td rel='"+route.fromLine.lineId+"-"+route.toLine.lineId+"'>"+route.fromLine.lineName+"-"+route.toLine.lineName+"</td>";
				tr += "<td rel='"+route.fromLine.lineDir+"'>"+route.fromLine.lineName+(route.fromLine.lineDir==2?"上行":"下行")+"</td>";
				tr += "<td>"+this.fromTrain.trainId+"</td>";
				tr += "<td>"+formatDate(this.fromTrain.arrivalTime)+"</td>";
				tr += "<td>"+Math.floor(this.walkTime/60)+"分钟"+"</td>";
				tr += "<td rel='"+route.toLine.lineDir+"'>"+route.toLine.lineName+(route.toLine.lineDir==2?"上行":"下行")+"</td>";
				if(this.toTrain) {
					tr += "<td>"+this.toTrain.trainId+"</td>";
					tr += "<td>"+formatDate(this.toTrain.departureTime)+"</td>";
					tr += "<td>"+Math.floor(this.waitTime/60)+"分钟"+"</td>";
					tr += "<td>可达</td>";
				} else {
					tr += "<td style='background-color:#BFBFBF'>&nbsp;</td>";
					tr += "<td style='background-color:#BFBFBF'>&nbsp;</td>";
					tr += "<td style='background-color:#BFBFBF'>&nbsp;</td>";
					tr += "<td style='background-color:#BFBFBF'>不可达</td>";
				}
				tr += "</tr>";
				routes.push([route.fromLine.lineId, route.toLine.lineId, route.fromLine.lineDir, route.toLine.lineDir, $(tr)]);
			});
			routes.sort(function(a, b) {
				return (a[0] - b[0] != 0)?(a[0] - b[0]):((a[1] - b[1] != 0)?(a[1] - b[1]):((a[2] - b[2] != 0)?(a[2] - b[2]):((a[3] - b[3] != 0)?(a[3] - b[3]):0)));
			});
			for(var i = 1; i < routes.length; i++) {
				var up = routes[i-1][4], down = routes[i][4];
				if(up.children(":eq(1)").attr("rel") == down.children(":eq(1)").attr("rel")) {
					up.children(":eq(1),:eq(2),:eq(3)").attr("rowspan", 2);
					down.children(":eq(1),:eq(2),:eq(3)").remove();
					i++;
				}
			}
			for(var i = 0; i < routes.length; i++) {
				var up = routes[i][4], j = i + 1;
				while(j < routes.length) {
					var down = routes[j][4];
					if(up.children(":eq(0)").attr("rel") != down.children(":eq(0)").attr("rel"))
						break;
					down.children(":eq(0)").remove();
					j++;
				}
				if(j - i > 1) {
					up.children(":eq(0)").attr("rowspan", j - i);
					i += (j - i - 1);
				}
			}
			var tbody = $(".station-view tbody").empty();
			$.each(routes, function() {
				tbody.append(this[4]);
			});
			if(result.reachable && result.reachable.length > 0) {
				tbody.append("<tr><td colspan='10' style='color:#F00; font-size:18px; font-weight:bold; " +
					"text-align:center; background-color:#FFF;'>最晚换乘时间</td></tr>");
				routes = [];
				$.each(result.reachable, function() {
					var route = _availableRoutes[this.routeId];
					var tr = "<tr>";
					tr += "<td rel='"+route.fromLine.lineId+"-"+route.toLine.lineId+"'>"+route.fromLine.lineName+"-"+route.toLine.lineName+"</td>";
					tr += "<td rel='"+route.fromLine.lineDir+"'>"+route.fromLine.lineName+(route.fromLine.lineDir==2?"上行":"下行")+"</td>";
					tr += "<td>"+this.fromTrain.trainId+"</td>";
					tr += "<td>"+formatDate(this.fromTrain.arrivalTime)+"</td>";
					tr += "<td>"+Math.floor(this.walkTime/60)+"分钟"+"</td>";
					tr += "<td rel='"+route.toLine.lineDir+"'>"+route.toLine.lineName+(route.toLine.lineDir==2?"上行":"下行")+"</td>";
					tr += "<td>"+this.toTrain.trainId+"</td>";
					tr += "<td>"+formatDate(this.toTrain.departureTime)+"</td>";
					tr += "<td>"+Math.floor(this.waitTime/60)+"分钟"+"</td>";
					tr += "<td>可达</td>";
					tr += "</tr>";
					routes.push([route.fromLine.lineId, route.toLine.lineId, route.fromLine.lineDir, route.toLine.lineDir, $(tr)]);
				});
				routes.sort(function(a, b) {
					return (a[0] - b[0] != 0)?(a[0] - b[0]):((a[1] - b[1] != 0)?(a[1] - b[1]):((a[2] - b[2] != 0)?(a[2] - b[2]):((a[3] - b[3] != 0)?(a[3] - b[3]):0)));
				});
				for(var i = 1; i < routes.length; i++) {
					var up = routes[i-1][4], down = routes[i][4];
					if(up.children(":eq(1)").attr("rel") == down.children(":eq(1)").attr("rel")) {
						up.children(":eq(1),:eq(2),:eq(3)").attr("rowspan", 2);
						down.children(":eq(1),:eq(2),:eq(3)").remove();
						i++;
					}
				}
				for(var i = 0; i < routes.length; i++) {
					var up = routes[i][4], j = i + 1;
					while(j < routes.length) {
						var down = routes[j][4];
						if(up.children(":eq(0)").attr("rel") != down.children(":eq(0)").attr("rel"))
							break;
						down.children(":eq(0)").remove();
						j++;
					}
					if(j - i > 1) {
						up.children(":eq(0)").attr("rowspan", j - i);
						i += (j - i - 1);
					}
				}
				$.each(routes, function() {
					tbody.append(this[4]);
				});
			}
			
			var fromDir = _linesDirInStation[stationId][from];
			var toDir = _linesDirInStation[stationId][to];
			var quadrant = [];
			if(fromDir == "WE" && toDir == "SN")
				quadrant = [ [2,2], [1,2], [1,1], [2,1] ];
			else if(fromDir == "NS" && toDir == "EW")
				quadrant = [ [2,2], [2,1], [1,1], [1,2] ];
			else if(fromDir == "EW" && toDir == "SN")
				quadrant = [ [1,2], [2,2], [2,1], [1,1] ];
			else if(fromDir == "NS" && toDir == "WE")
				quadrant = [ [2,1], [2,2], [1,2], [1,1] ];
			else if(fromDir == "EW" && toDir == "NS")
				quadrant = [ [1,1], [2,1], [2,2], [1,2] ];
			else if(fromDir == "SN" && toDir == "WE")
				quadrant = [ [1,1], [1,2], [2,2], [2,1] ];
			else if(fromDir == "WE" && toDir == "NS")
				quadrant = [ [2,1], [1,1], [1,2], [2,2] ];
			else if(fromDir == "SN" && toDir == "EW")
				quadrant = [ [1,2], [1,1], [2,1], [2,2] ];
			routes = {};
			for(var i = 0; i < quadrant.length; i++) {
				$.each(_availableRoutes, function(routeId) {
					if(this.fromLine.lineId == from && this.toLine.lineId == to
							&& this.fromLine.lineDir == quadrant[i][0]
							&& this.toLine.lineDir == quadrant[i][1])
						routes[routeId] = i;
				});
			}
			var tooltips = $(".station-view .tooltip").hide();
			$.each(result.lastest, function() {
				if(typeof routes[this.routeId] == "undefined") return;
				var tooltip = tooltips.eq(routes[this.routeId]);
				if(this.toTrain) {
					tooltip.find(".from-train-id").text(this.fromTrain.trainId);
					tooltip.find(".from-arrival-time").text(formatTime(this.fromTrain.arrivalTime));
					tooltip.find(".to-train-id").text(this.toTrain.trainId);
					tooltip.find(".from-departure-time").text(formatTime(this.toTrain.departureTime));
					tooltip.find(".walk-time").text(Math.floor(this.walkTime/60));
					tooltip.find(".wait-time").text(Math.floor(this.waitTime/60));
					tooltip.find(".yesno").hide();
				} else {
					var routeId = this.routeId;
					$.each(result.reachable, function() {
						if(this.routeId == routeId) {
							tooltip.find(".from-train-id").text(this.fromTrain.trainId);
							tooltip.find(".from-arrival-time").text(formatTime(this.fromTrain.arrivalTime));
							tooltip.find(".to-train-id").text(this.toTrain.trainId);
							tooltip.find(".from-departure-time").text(formatTime(this.toTrain.departureTime));
							tooltip.find(".walk-time").text(Math.floor(this.walkTime/60));
							tooltip.find(".wait-time").text(Math.floor(this.waitTime/60));
							tooltip.find(".yesno").show();
							return false;
						}
					});
				}
				tooltip.show();
			});
			
			var horizontalFirst = fromDir == "WE" || fromDir == "EW";
			var fromLineName = $(fromLineSelector).children("[value="+from+"]").text();
			var fromLineColor = _linesColor[from];
			var toLineName = $(toLineSelector).children("[value="+to+"]").text();
			var toLineColor = _linesColor[to];
			if(stopLastAnimation) stopLastAnimation();
			if(horizontalFirst)
				stopLastAnimation = enterStation(true, fromLineName, fromLineColor, toLineName, toLineColor);
			else
				stopLastAnimation = enterStation(false, toLineName, toLineColor, fromLineName, fromLineColor);
			zoomIntoStation(stationId, function() {
				$(".overview").hide().find("img").css("opacity", 1);
				$(".station-view").fadeIn("slow").find("h2").text(stationName);
			});
		}, "json");
	};
	$("#query-btn").click(function() {
		$("#reset-btn").click();
		queryAction($("#stations").val(), $("#stations :selected").text(), "#lines-from", "#lines-to", "#lines-from ~ :checkbox", "#lines-to ~ :checkbox");
	});
	// 重置动作
	$("#reset-btn").click(function() {
		$("#map-tooltip .close-btn-icon").click();
		resetMap();
		$(".overview").show();
		$(".station-view").hide();
	});
});

$(function() {
	// ---------- 全局地图相关 ----------------
	// 调整地图大小，缩放适合屏幕
	var defHeight = $(window).height() - 168;
	$(".overview").height(defHeight);
	var defWidth = 870;
	var img = $(".overview img").width(defWidth);
	img.load(function() {
		img.css("top", (defHeight - img.height()) / 2);
	});
	window.resetMap = function() {
		img.stop(true).animate({ width: defWidth, top: (defHeight - defWidth * WIDTH / HEIGHT) / 2, left: 0 }, "slow");
	};
	var WIDTH = 2082, HEIGHT = 1921;
	// 缩放按钮
	$("#zoom-in-btn").click(function() {
		var width = img.width() * 4 / 3 > WIDTH ? WIDTH - img.width() : img.width() / 3;
		var top = (-img.css("top").substr(0, img.css("top").length - 2) + defHeight / 2) * width / img.width();
		var left = (-img.css("left").substr(0, img.css("left").length - 2) + defWidth / 2) * width / img.width();
		img.stop(true).animate({ width: "+=" + width, top: "-=" + top, left: "-=" + left });
	});
	$("#zoom-out-btn").click(function() {
		var width = img.width() * 2 / 3 < defWidth ? img.width() - defWidth : img.width() / 3;
		var top = (-img.css("top").substr(0, img.css("top").length - 2) + defHeight / 2) * width / img.width();
		var left = (-img.css("left").substr(0, img.css("left").length - 2) + defWidth / 2) * width / img.width();
		img.stop(true).animate({ width: "-=" + width, top: "+=" + top, left: "+=" + left });
	});
	// 移动按钮
	$("#move-north-btn").click(function() {
		var top = +img.css("top").substr(0, img.css("top").length - 2);
		img.stop(true).animate({ top: "+=" + (top > -300 ? -top : 300) });
	});
	$("#move-south-btn").click(function() {
		var top = +img.css("top").substr(0, img.css("top").length - 2);
		img.stop(true).animate({ top: "-=" + (top + img.height() - defHeight < 300 ? top + img.height() - defHeight : 300) });
	});
	$("#move-west-btn").click(function() {
		var left = +img.css("left").substr(0, img.css("left").length - 2);
		img.stop(true).animate({ left: "+=" + (left > -300 ? -left : 300) });
	});
	$("#move-east-btn").click(function() {
		var x = 300;
		var left = +img.css("left").substr(0, img.css("left").length - 2);
		img.stop(true).animate({ left: "-=" + (left + img.width() - defWidth < 300 ? left + img.width() - defWidth : 300) });
	});
	window.zoomIntoStation = function(stationId, callback) {
		var x = WIDTH / 2, y = HEIGHT / 2;
		for(var i = 0; i < _stationsPoint.length; i++) {
			if(_stationsPoint[i].stationId == stationId) {
				x = _stationsPoint[i].x;
				y = _stationsPoint[i].y;
				break;
			}
		}
		img.stop(true).animate({ width: WIDTH * 3, top: defHeight / 2 - y * 3, left: defWidth / 2 - x * 3, opacity: 0.4 }, 1000, callback);
	};
	var _stationsPoint = [];
	// 获取各站点在地图中的坐标
	$.post("service/getAllStationsPoint.json", function(result) {
		if(!result) return;
		_stationsPoint = result;
	}, "json");
	// 提示框
	img.mousemove(function(e) {
		var x = e.offsetX * WIDTH / img.width(), y = e.offsetY * HEIGHT / img.height();
		for(var i = 0; i < _stationsPoint.length; i++) {
			if(Math.pow(_stationsPoint[i].x - x, 2) + Math.pow(_stationsPoint[i].y - y, 2) < 900) {
				img.css("cursor", "pointer").data("station", _stationsPoint[i].stationId).data("stationName", _stationsPoint[i].stationName);
				return;
			}
		}
		img.css("cursor", "auto");
	}).click(function(e) {
		if(img.css("cursor") != "pointer") return;
		chooseStation(img.data("station"), "#lines-from-mini", "#lines-to-mini", function() {
			$("#map-tooltip").css({ left: e.pageX-185, top: e.pageY+5 }).fadeIn().find(":checkbox").attr("checked", true);
		});
	});
	$("#map-tooltip .close-btn-icon,#map-tooltip .confirm-btn-icon,.overview button").click(function() {
		$("#map-tooltip").fadeOut();
	});
	$("#lines-from-mini,#lines-to-mini").change(function() {
		var me = $(this);
		var she = me.siblings("select");
		if(me.val() == she.val())
			she.children(":selected").siblings(":first").attr("selected", true);
	});
	$("#lines-from-mini ~ :checkbox,#lines-to-mini ~ :checkbox").change(function() {
		if($(this).attr("checked")) return;
		$(this).siblings(":checkbox[name="+$(this).attr("name")+"]:first").attr("checked", true);
	});
	$("#map-tooltip .confirm-btn-icon").click(function() {
		queryAction(img.data("station"), img.data("stationName"), "#lines-from-mini", "#lines-to-mini", "#lines-from-mini ~ :checkbox", "#lines-to-mini ~ :checkbox");
	});
});

$(function() {
	// 车站地图相关
	// 初始化相关元素
	var WIDTH = 870, HEIGHT = $(window).height() - 168, INTERVAL = 5;
	var paper = Raphael($(".station-view")[0], WIDTH, HEIGHT);
	var gradient = function(dir) {
		return function(num) {
			if(num == 0 || num == 100)
				return { fill: "#3B6188" };
			if(num < 5)
				return { fill: dir+"-#E9DF72-#3B6188:"+(num+5)+"-#3B6188" };
			else if(num > 95)
				return { fill: dir+"-#3B6188-#3B6188:"+(num-5)+"-#E9DF72" };
			else
				return { fill: dir+"-#3B6188-#3B6188:"+(num-5)+"-#E9DF72:"+num+"-#3B6188:"+(num+5)+"-#3B6188" };
		};
	};
	paper.customAttributes.gra_e = gradient(0);
	paper.customAttributes.gra_n = gradient(90);
	paper.customAttributes.gra_w = gradient(180);
	paper.customAttributes.gra_s = gradient(270);
	var lines = [];
	lines.push(paper.rect(0, 160, 200, 20).attr({ stroke: "none" }));
	lines.push(paper.rect(200, 0, 20, 160).attr({ stroke: "none" }));
	lines.push(paper.rect(0, 200, 200, 20).attr({ stroke: "none" }));
	lines.push(paper.rect(200, 220, 20, HEIGHT-220).attr({ stroke: "none" }));
	lines.push(paper.rect(260, 160, WIDTH-260, 20).attr({ stroke: "none" }));
	lines.push(paper.rect(240, 0, 20, 160).attr({ stroke: "none" }));
	lines.push(paper.rect(260, 200, WIDTH-260, 20).attr({ stroke: "none" }));
	lines.push(paper.rect(240, 220, 20, HEIGHT-220).attr({ stroke: "none" }));
	paper.circle(230, 190, 50).attr({ fill: "#C33B3D", stroke: "none" });
	var horizontalColor = paper.rect(WIDTH-130, 110, 120, 40, 10);
	var verticalColor = paper.rect(70, HEIGHT-50, 120, 40, 10);
	// 进入车站，开始动画
	window.enterStation = function(horizontalFirst, horizontalLineName, horizontalLineColor, verticalLineName, verticalLineColor) {
		$(".station-view h3:first").text(horizontalLineName).css({ top: 120, left: WIDTH-100 });
		$(".station-view h3:last").text(verticalLineName).css({ top: HEIGHT-40, left: 100 });
		horizontalColor.attr({ fill: horizontalLineColor });
		verticalColor.attr({ fill: verticalLineColor });
		lines[0].attr(horizontalFirst ? { gra_e: 0 } : { gra_w: 0 });
		lines[1].attr(horizontalFirst ? { gra_n: 0 } : { gra_s: 0 });
		lines[2].attr(horizontalFirst ? { gra_e: 0 } : { gra_w: 0 });
		lines[3].attr(horizontalFirst ? { gra_s: 0 } : { gra_n: 0 });
		lines[4].attr(horizontalFirst ? { gra_w: 0 } : { gra_e: 0 });
		lines[5].attr(horizontalFirst ? { gra_n: 0 } : { gra_s: 0 });
		lines[6].attr(horizontalFirst ? { gra_w: 0 } : { gra_e: 0 });
		lines[7].attr(horizontalFirst ? { gra_s: 0 } : { gra_n: 0 });
		var running = true;
		(function() {
			if(!running) return;
			var func = arguments.callee;
			if(horizontalFirst) {
				lines[0].stop().animate({ gra_e: 100 }, 200 * INTERVAL, function() {
					lines[0].attr({ gra_e: 0 });
					lines[1].stop().animate({ gra_n: 100 }, 160 * INTERVAL, function() {
						lines[1].attr({ gra_n: 0 });
						func();
					});
				});
			} else {
				lines[1].stop().animate({ gra_s: 100 }, 160 * INTERVAL, function() {
					lines[1].attr({ gra_s: 0 });
					lines[0].stop().animate({ gra_w: 100 }, 200 * INTERVAL, function() {
						lines[0].attr({ gra_w: 0 });
						func();
					});
				});
			}
		})();
		(function() {
			if(!running) return;
			var func = arguments.callee;
			if(horizontalFirst) {
				lines[2].stop().animate({ gra_e: 100 }, 200 * INTERVAL, function() {
					lines[2].attr({ gra_e: 0 });
					lines[3].stop().animate({ gra_s: 100 }, (HEIGHT-220) * INTERVAL, function() {
						lines[3].attr({ gra_s: 0 });
						func();
					});
				});
			} else {
				lines[3].stop().animate({ gra_n: 100 }, (HEIGHT-220) * INTERVAL, function() {
					lines[3].attr({ gra_n: 0 });
					lines[2].stop().animate({ gra_w: 100 }, 200 * INTERVAL, function() {
						lines[2].attr({ gra_w: 0 });
						func();
					});
				});
			}
		})();
		(function() {
			if(!running) return;
			var func = arguments.callee;
			if(horizontalFirst) {
				lines[4].stop().animate({ gra_w: 100 }, (WIDTH-260) * INTERVAL, function() {
					lines[4].attr({ gra_w: 0 });
					lines[5].stop().animate({ gra_n: 100 }, 160 * INTERVAL, function() {
						lines[5].attr({ gra_n: 0 });
						func();
					});
				});
			} else {
				lines[5].stop().animate({ gra_s: 100 }, 160 * INTERVAL, function() {
					lines[5].attr({ gra_s: 0 });
					lines[4].stop().animate({ gra_e: 100 }, (WIDTH-260) * INTERVAL, function() {
						lines[4].attr({ gra_e: 0 });
						func();
					});
				});
			}
		})();
		(function() {
			if(!running) return;
			var func = arguments.callee;
			if(horizontalFirst) {
				lines[6].stop().animate({ gra_w: 100 }, (WIDTH-260) * INTERVAL, function() {
					lines[6].attr({ gra_w: 0 });
					lines[7].stop().animate({ gra_s: 100 }, (HEIGHT-220) * INTERVAL, function() {
						lines[7].attr({ gra_s: 0 });
						func();
					});
				});
			} else {
				lines[7].stop().animate({ gra_n: 100 }, (HEIGHT-220) * INTERVAL, function() {
					lines[7].attr({ gra_n: 0 });
					lines[6].stop().animate({ gra_e: 100 }, (WIDTH-260) * INTERVAL, function() {
						lines[6].attr({ gra_e: 0 });
						func();
					});
				});
			}
		})();
		return function() {
			running = false;
		};
	};
});

function padLeft(num) {
	if(num < 10) return "0" + num;
	return num;
}

function formatDate(time) {
	time = new Date(time);
	return (time.getFullYear() + "-" + padLeft(time.getMonth() + 1) + "-" + padLeft(time.getDate()) + " " +
		padLeft(time.getHours()) + ":" + padLeft(time.getMinutes()) + ":" + padLeft(time.getSeconds()));
}

function formatTime(time) {
	time = new Date(time);
	return (padLeft(time.getHours()) + ":" + padLeft(time.getMinutes()) + ":" + padLeft(time.getSeconds()));
}
		</script>
	</head>
	<body>
		<div class="container">
			<hr class="space"/><h1 class="quiet">北京轨道交通路网列车衔接模型</h1><hr class="bottom"/>
			<h4 class="span-3 colborder menu"><a href="first.html">首班车衔接信息</a></h4>
			<h4 class="span-3 colborder menu"><a href="last.html">末班车衔接信息</a></h4>
			<h4 class="span-4 colborder menu"><a href="time.html">常规时间衔接信息</a></h4>
			<h4 class="span-4 colborder menu"><a href="#">路径出行信息查询</a></h4>
			<h4 class="span-3 colborder menu"><a href="#">换乘站服务水平</a></h4>
			<h4 class="span-3 colborder menu"><a href="#">列车行车间隔</a></h4>
			<h4 class="span-8 last menu">&nbsp;</h4><hr/>
			<div class="span-8">
				<div class="radius-border">
					<h4 class="query-box-title">常规时间换乘站衔接信息查询</h4>
					<div class="query-box-body">
						<p><label>选择换乘站：</label><select id="stations"><option class="default" value="0">请选择</option></select></p>
						<p>
							<input type="radio" name="time-mode" value="0" checked="checked" /><label>检索时刻</label><br/>
							<select class="hours"></select> 时 <select class="minutes"></select> 分
						</p>
						<p class="lines" style="display:none">
							<label>换出线路：</label><select id="lines-from"></select>&nbsp; 
							<input type="checkbox" value="2" />上行 &nbsp;
							<input type="checkbox" value="1" />下行
						</p>
						<p class="lines" style="display:none">
							<label>换入线路：</label><select id="lines-to"></select>&nbsp; 
							<input type="checkbox" value="2" />上行 &nbsp;
							<input type="checkbox" value="1" />下行
						</p>
						<p class="buttons"><button id="query-btn">检索</button><button id="reset-btn">重置</button></p>
					</div>
				</div>
			</div>
			<div class="span-22 last">
				<div class="overview">
					<img src="resources/images/overview.png" />
					<button id="zoom-in-btn" style="top:80px; left:35px;">+</button>
					<button id="move-north-btn" style="top:122px; left:35px;">↑</button>
					<button id="move-south-btn" style="top:186px; left:35px;">↓</button>
					<button id="move-west-btn" style="top:154px; left:10px;">←</button>
					<button id="move-east-btn" style="top:154px; left:60px;">→</button>
					<button id="zoom-out-btn" style="top:228px; left:35px;">-</button>
				</div>
				<div class="station-view" style="display:none">
					<h2>&nbsp;</h2>
					<h3>&nbsp;</h3>
					<h3>&nbsp;</h3>
					<table border="0" cellspacing="0" cellpadding="0">
						<thead>
							<tr>
								<th width="90px">换出/换入</th>
								<th width="90px">到达车<br/>行车方向</th>
								<th width="50px">到达车<br/>车次</th>
								<th width="80px">到达车<br/>到达时刻</th>
								<th width="50px">换乘<br/>时间</th>
								<th width="90px">换乘车<br/>行车方向</th>
								<th width="50px">换乘车<br/>车次</th>
								<th width="80px">换乘车<br/>发车时刻</th>
								<th width="50px">等待<br/>时间</th>
								<th width="50px">是否<br/>可达</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
					<div class="tooltip" style="top:10px; left:10px; display:none;">
						<h4 class="bottom">到达车<span class="yesno" style="display:none">不</span>可换乘</h4>
						<hr class="bottom" style="margin:5px 0" />
						<span class="yesno" style="display:none">最晚换乘方案</span><br/>
						到达车<span class="from-train-id">0000</span>次(<span class="from-arrival-time">00:00</span>到达)<br/>
						换乘<span class="to-train-id">0000</span>次(<span class="from-departure-time">00:00</span>发车)<br/>
						换乘时间：<span class="walk-time">0</span>分钟<br/>
						等待时间：<span class="wait-time">0</span>分钟
					</div>
					<div class="tooltip" style="top:10px; left:280px; display:none;">
						<h4 class="bottom">到达车<span class="yesno" style="display:none">不</span>可换乘</h4>
						<hr class="bottom" style="margin:5px 0" />
						<span class="yesno" style="display:none">最晚换乘方案</span><br/>
						到达车<span class="from-train-id">0000</span>次(<span class="from-arrival-time">00:00</span>到达)<br/>
						换乘<span class="to-train-id">0000</span>次(<span class="from-departure-time">00:00</span>发车)<br/>
						换乘时间：<span class="walk-time">0</span>分钟<br/>
						等待时间：<span class="wait-time">0</span>分钟
					</div>
					<div class="tooltip" style="top:240px; left:280px; display:none;">
						<h4 class="bottom">到达车<span class="yesno" style="display:none">不</span>可换乘</h4>
						<hr class="bottom" style="margin:5px 0" />
						<span class="yesno" style="display:none">最晚换乘方案</span><br/>
						到达车<span class="from-train-id">0000</span>次(<span class="from-arrival-time">00:00</span>到达)<br/>
						换乘<span class="to-train-id">0000</span>次(<span class="from-departure-time">00:00</span>发车)<br/>
						换乘时间：<span class="walk-time">0</span>分钟<br/>
						等待时间：<span class="wait-time">0</span>分钟
					</div>
					<div class="tooltip" style="top:240px; left:10px; display:none;">
						<h4 class="bottom">到达车<span class="yesno" style="display:none">不</span>可换乘</h4>
						<hr class="bottom" style="margin:5px 0" />
						<span class="yesno" style="display:none">最晚换乘方案</span><br/>
						到达车<span class="from-train-id">0000</span>次(<span class="from-arrival-time">00:00</span>到达)<br/>
						换乘<span class="to-train-id">0000</span>次(<span class="from-departure-time">00:00</span>发车)<br/>
						换乘时间：<span class="walk-time">0</span>分钟<br/>
						等待时间：<span class="wait-time">0</span>分钟
					</div>
				</div>
			</div>
		</div>
		<div id="map-tooltip" style="display:none">
			<div class="close-btn-icon">&nbsp;</div>
			<label>换出线路：</label><select id="lines-from-mini"></select><br/>
			<input type="checkbox" name="from" value="2" />上行 &nbsp;
			<input type="checkbox" name="from" value="1" />下行<br/>
			<label>换入线路：</label><select id="lines-to-mini"></select><br/>
			<input type="checkbox" name="to" value="2" />上行 &nbsp;
			<input type="checkbox" name="to" value="1" />下行
			<div class="confirm-btn-icon">&nbsp;</div>
		</div>
	</body>
</html>